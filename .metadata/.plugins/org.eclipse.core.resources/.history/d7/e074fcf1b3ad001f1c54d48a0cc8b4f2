#include "main.h"
#include "cmsis_os.h"
#include "logger.h"
#include "dwt.h"
#include "board.h"

#include "app.h"

#define LED_AO_TASK_PRIORITY (tskIDLE_PRIORITY + 1)
#define UI_AO_TASK_PRIORITY (tskIDLE_PRIORITY + 1)
#define BUTTON_TASK_PRIORITY (tskIDLE_PRIORITY + 1)

static ao_t ao_ui;
static pao_t pao_leds;

static system_t system = {
		.ui = &ao_ui,
		.leds = &pao_leds,
};

enum {
  RED_LED_AO_ID = 1,
  GREEN_LED_AO_ID,
  BLUE_LED_AO_ID,
  UI_INTERFACE_AO_ID
};

void app_init(void)
{
	init_ui_active_object(&ao_ui, ui_process_event, UI_AO_TASK_PRIORITY);
	init_led_pactive_object(&ao_leds, leds_process_event, LED_AO_TASK_PRIORITY);

	BaseType_t status;
	status = xTaskCreate(task_button, "Button_Task", configMINIMAL_STACK_SIZE, &system, BUTTON_TASK_PRIORITY, NULL);
	configASSERT(pdPASS = status);

	while (pdPASS != status)
	{
		// error
	}

	LOGGER_INFO("app init");

	cycle_counter_init();
}
